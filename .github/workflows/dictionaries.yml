name: Generate Dictionaries

on:
  workflow_dispatch: # Manual trigger
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: "0 2 * * 1"
  push:
    paths:
      - "scripts/download-dicts.js"
      - "scripts/parse-dicts.js"
      - ".github/workflows/dictionaries.yml"

permissions:
  contents: write

jobs:
  generate-dictionaries:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Download dictionaries
        run: node scripts/download-dicts.js

      - name: Parse dictionaries
        run: node scripts/parse-dicts.js

      - name: Compress dictionaries
        run: |
          cd public/dicts
          # Compress with maximum compression (-9) and keep original files (-k)
          gzip -k -9 en.json ru.json ru-strict.json
          # Verify compressed files exist
          if [ ! -f en.json.gz ] || [ ! -f ru.json.gz ] || [ ! -f ru-strict.json.gz ]; then
            echo "Error: Failed to compress dictionaries"
            exit 1
          fi
          echo "Compressed dictionaries:"
          ls -lh *.json*
          echo ""
          echo "Compression ratios:"
          du -h en.json en.json.gz | awk '{print $1}' | paste - - | awk '{printf "en.json: %s -> %s (%.1f%% reduction)\n", $1, $2, (1-$2/$1)*100}'
          du -h ru.json ru.json.gz | awk '{print $1}' | paste - - | awk '{printf "ru.json: %s -> %s (%.1f%% reduction)\n", $1, $2, (1-$2/$1)*100}'
          du -h ru-strict.json ru-strict.json.gz | awk '{print $1}' | paste - - | awk '{printf "ru-strict.json: %s -> %s (%.1f%% reduction)\n", $1, $2, (1-$2/$1)*100}'

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Prepare dictionaries for assets branch
        run: |
          mkdir -p /tmp/dicts
          cp public/dicts/*.json.gz /tmp/dicts/ || true
          cp public/dicts/*.json /tmp/dicts/ 2>/dev/null || true

      - name: Checkout or create assets branch
        run: |
          # Fetch all branches and tags
          git fetch origin --prune
          # Get the current repository name for reference
          REPO_NAME=$(git remote get-url origin | sed 's/.*github.com[:/]\([^.]*\)\.git/\1/')
          echo "Repository: $REPO_NAME"
          echo "Assets branch will be: https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/"
          # Try to checkout assets branch, create if it doesn't exist
          if git show-ref --verify --quiet refs/remotes/origin/assets; then
            echo "Assets branch exists, checking out..."
            git checkout -b assets origin/assets 2>/dev/null || git checkout assets
            git pull origin assets || true
          else
            echo "Assets branch does not exist, creating..."
            # Create from current branch (usually main)
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git checkout -b assets
            # Remove all files except dicts (clean branch)
            git rm -rf . 2>/dev/null || true
          fi
          mkdir -p dicts

      - name: Copy dictionaries to assets branch
        run: |
          cp /tmp/dicts/*.json.gz dicts/ || true
          cp /tmp/dicts/*.json dicts/ 2>/dev/null || true

      - name: Create commit and push
        run: |
          git add dicts/
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Update dictionaries - $(date -u +'%Y-%m-%d %H:%M:%S UTC')" || exit 0
            git push origin assets
            echo "âœ“ Dictionaries pushed to assets branch"
          else
            echo "No changes to commit"
          fi

      - name: Summary
        run: |
          REPO_NAME=$(git remote get-url origin | sed 's/.*github.com[:/]\([^.]*\)\.git/\1/')
          echo "## Dictionary Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Dictionaries are available at:" >> $GITHUB_STEP_SUMMARY
          echo "### English" >> $GITHUB_STEP_SUMMARY
          echo "- Compressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/en.json.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Uncompressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/en.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Russian (Full)" >> $GITHUB_STEP_SUMMARY
          echo "- Compressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/ru.json.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Uncompressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/ru.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Russian (Strict)" >> $GITHUB_STEP_SUMMARY
          echo "- Compressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/ru-strict.json.gz\`" >> $GITHUB_STEP_SUMMARY
          echo "- Uncompressed: \`https://raw.githubusercontent.com/${REPO_NAME}/assets/dicts/ru-strict.json\`" >> $GITHUB_STEP_SUMMARY
